# DHCP
## DHCP_v4

### Клиент серверная модель DHCP
![alt text](image.png)

DHCP работает по клиент-серверной модели, где клиент отправляет запросы серверу dhcp, а затем dhcp предоставляет свои услуги клиенту

### Получение IP Адреса
![alt text](image-1.png)

DHCP используется для получения сетевых настроек клиентом.  
  
Чтобы это произошло, клиенту, который впервые подключается к сети и настроенному для автоматической настройки сетевого интерфейса, нужно отправить в сеть сообщение __DHCP DISCOVER__, чтобы найти DHCP сервер  
  
![alt text](image-2.png)

Если в локальной сети клиента существует DHCP сервер, то он отправляет DHCP OFFER на unicast либо broadcast адрес с предложением сетевых настроек    
  
![alt text](image-3.png)
Клиент отвечает на оффер сообщением DHCP Request, если он принимает настройки dhcp сервера, отправляя его на broadcast адрес  
  

![alt text](image-4.png)

Сервер подтверждает настройки клиента с помощью DHCP ACK. Может быть разослан как на Unicast, так и на Broadcast адреса  
  
__Таким образом у клиента в сети появляется:__
1. IP адрес
2. маска сети 
3. шлюз по умолчанию 
4. и прочие сетевые настройки по типу адреса DNS сервера, доменного имени

### Продление аренды IP адреса

![alt text](image-5.png)

Все IP адреса выдаются DHCP сервером на время, называемое __Временем аренды__. Это делается для того, чтобы мертвые клиенты, которые единожды подключились к сети и после этого перестали ей пользоваться, не занимали выделенные адреса.  

По истечению времени аренды, если клиент хочет продолжать пользоваться ip адресом, ему необходимо продлить аренду. Продление аренды происходит в 2 этапа:
1. Клиент отправляет DHCP серверу сообщение __DHCPREQUEST__ на Unicast адрес(т.к клиент знает, у какого DHCP сервера он брал IP адрес ) с просьбой продлить старый адрес.
2. Если это возможно, то сервер отправляет __DHCP ACK__, подтверждая продление 

### Команды настройки

В больших сетях рекомендуется использовать выделенный DHCP сервер, который будет обслуживать клиентов сети  
В малых сетях DHCP сервер можно настроить и на маршрутизаторе, локальном для этой сети

* на первом этапе нужно исключить некоторые ip адреса, такими адреса могут быть определены строго заданными настройками на какое-то оборудование клиента в сети либо на сетевое оборудование.
* Например это могут быть адреса, выделенные для шлюза по умолчанию для этой сети, принтеров, серверов, которые дожны иметь фиксированный постоянный адрес. 

__Исключить IPv4 адреса__
> R(config)# ip dhcp excluded-address _low_address_ [_high\_address_] 
> > С помощью этой команды можно исключить один адрес (если указываем только один адрес) либо целый диапозон адресов (при указании _low_address_ и _high\_address_)

* После исключения ненужных IP адресов, нужно задать пул адресов, которые будут выдаваться клиентам

__Создать пул DHCP__
> R(config)# ip dhcp pool _pool\_name_

* В режиме dhcp-config(перешли туда через предыдущую команду) можем задать пул адресов с помощью network. Указываем целый диапозон адресов

__Задать пул адресов__
> R(dhcp-config)# network _network-number_ [_mask_ &nbsp; | &nbsp; / _prefix-legnth_]

* Также стоит указать адрес маршрутизатора, который будет играть роль шлюза по умолчанию. Можно задать до 8 адресов за раз

__Задать маршрутизатор или шлюз по умолчанию__
> R(dhcp-config)# default-router _address_ &nbsp; [ address2 ... addres8 ]

* Дальше можно задать время аренды ip адресов. По умолчанию адреса выдаются на сутки

**Задать время аренды IP-адреса**
> R(dhcp-config)# lease *{days [hours [minutes]]* &nbsp; | &nbsp; *infinite}*

### Пример настройки DHCP сервера
![alt text](image-6.png)

### Проверка настроек DHCP сервера
Во-первых можно использовать **команду просмотра конфигурации**, чтобы убедиться, что были использованы все нужные команды
![alt text](image-7.png)

Чтобы проверить роботоспособность сервера, **можно посмотреть привязки выданных IP адресов к MAC адресам клиентов** 
![alt text](image-8.png)

Также можно посмотреть **статистику DHCP сервера**, чтобы посмотреть кол-во пакетов, которые были получены и переданы данным сервером
![alt text](image-9.png)

Чтобы **проверить IP адрес, выданный DHCP сервером, на клиенте**
![alt text](image-10.png) 

### Отключение DHCP сервера
Чтобы маршрутизатор мог быть DHCP сервером, у него должен быть запущен сооствествующий сервис(который называется DHCP, логично да ?). **Сервис DHCP запущен по умолчанию**  
Если зачем-то понадобилось отключить DHCP сервис, то его можно отключить в конфигурационном режиме
  
Если мы отключили сервис DHCP, при этом у нас были подключенные клиенты,настроенные на автоматическое получение IP адресов с нашего сервера, а также есть новые клиенты, которые хотят получить ip адрес, то может случиться так, что у разных клиентов будет один ip адрес, таким образом они потеряют возможность работать в сети.  
  
**Если соберешься отключать DHCP сервер, то нужно заранее подготовить клиентов к этому**
![alt text](image-11.png)

### Ретрансляция DHCP 
Уже расмотрели ситуацию, когда маршрутизатор выступает единственным DHCP сервером в локальной сети. Но в больших сетях удобнее иметь один выделенный сервер, к которому будут обращаться клиенты из разных сетей для получения сетевых настроек.  
Как мы помним маршрутизатор не пропускает широковещательный трафик через свои интерфейсы, а как мы помним, клиенты ищут DHCP сервер, используя Broadcast рассылку. Т.е если есть выделенный DHCP сервер отделен от локальной сети маршрутизатором, то он не сможет получить DHCP DISCOVER и не сможет обслужить клиентов.  
  
Чтобы бороться с такой ситуацией, необходимо настроить  режим ретрансляции широковещательных сообщений(режим ретрансляции UDP сообщений) на граничном маршрутизаторе локальной сети. Эта настройка настройка позволит передавать широковещательный трафик дальше по сети, позволяя ему достигнуть DHCP сервер.  

  
В нашем примере, если мы настраиваем ретрансляцию сообщений на роутере R1, то сообщение DHCP DISCOVER  от клиента PC1 будут переданы в неизменном виде дальше по сети и достигнут DHCP сервера.
![alt text](image-12.png)

### Настройка Ретрансляции
По умолчанию режим ретрансляции отключен. Включить ретрансляцию можно с **помощью команды (см первую картинку) в режиме настройки интерфейса, подключенного к той локальной сети, в которой у нас находятся клиенты**. 

> R(config-if)# ip helper-address *address*
> > В качестве *address* указывается ip адрес dhcp сервера

![alt text](image-13.png)
![alt text](image-14.png)

Такая настройка позволяет ретранслировать широковещательный служенбый трафик(сообщения протоколов, использующие транспортный протокол UDP, в нашем случае DHCP) через маршрутизаторы. Также будут пересылаться сообщения от DNS

### Настройка DHCP-Клиента
Роутеры могут выступать не только в качестве серверов DHCP, но и в качестве DHCP клиентов. Такая опция может понадобится, когда есть домашний граничный маршрутизатор и он должен динамически получать IP адрес от провайдера. В таком случае интерфейс маршрутизатора можно настроить в качестве клиента DHCP. **Делается это в настройке того самого интерфейса, который хотим настроить**
> R(config-if)# ip address dhcp
> > С помощью этой команды указываем, что IP адрес получаем динамически от DHCP сервера. **Также не забудь включить интерфейс после настройки**
![alt text](image-15.png)
![alt text](image-16.png)

### Show ip interface
Если посмотреть настройку интерфейса с помощью команды 
```
Show ip interface
```
, то можно увидеть, что был получен какой-то IP адрес с помощью DHCP (См последнюю строчку картинки)

![alt text](image-17.png)